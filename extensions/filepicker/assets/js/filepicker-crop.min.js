!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("jquery"),require("filepicker")):"function"==typeof define&&define.amd?define(["jquery","filepicker"],e):e(t.jQuery,t.Filepicker)}(this,function(t,e){"use strict";function i(t){t.extend(this,n)}function o(t){return t+=(t.indexOf("?")>-1?"&":"?")+(new Date).getTime()}t="default"in t?t["default"]:t,e="default"in e?e["default"]:e;var n={crop:{selectors:{crop:".crop",container:"#crop-modal",loading:".crop-loading",preview:".crop-preview",save:".crop-save",hide:".crop-hide",rotateLeft:".crop-rotate-left",rotateRight:".crop-rotate-right",flipHorizontal:".crop-flip-horizontal",flipVertical:".crop-flip-vertical"},guides:!1,center:!1,movable:!1,zoomable:!1,setDragMode:"crop",viewMode:1},messages:{cropLoadFail:"Could not load the image.",cropSaveFail:"Could not save the image."},cropsave:function(t,e){e.original&&this.trigger("renderdownload",t,{files:[e]}),this.plugins.crop.hide()},cropsavefail:function(t,e){alert(e.responseJSON||this.trans("cropSaveFail"))},cropsavealways:function(){this.plugins.crop.toggleSaveBtn(),this.plugins.crop.image.cropper("enable")},cropload:function(t,e){var i=this.plugins.crop;i.options.loading.hide(),i.options._preview.html(e).show(),i.image=e.cropper(i.options),i.options.saveBtn.prop("disabled",!1),this.trigger("cropper",t,[i.image])},croploadfail:function(){alert(this.trans("cropLoadFail"))}};i.prototype.init=function(){this.options=this.$f.options.crop,this._initOptions(),this._initHandlers()},i.prototype._initOptions=function(){var e=this.options,i=this.options.selectors;return e.container||(e.container=t(i.container)),e.container?(e.loading||(e.loading=e.container.find(i.loading)),e._preview||(e._preview=e.container.find(i.preview)),e.saveBtn||(e.saveBtn=e.container.find(i.save),e.saveBtn.prop("disabled",!0)),e.hideBtn||(e.hideBtn=e.container.find(i.hide)),e.rotateLeftBtn||(e.rotateLeftBtn=e.container.find(i.rotateLeft)),e.rotateRightBtn||(e.rotateRightBtn=e.container.find(i.rotateRight)),e.flipHorizontal||(e.flipHorizontal=e.container.find(i.flipHorizontal)),void(e.flipVertical||(e.flipVertical=e.container.find(i.flipVertical)))):!1},i.prototype._initHandlers=function(){var e=this,i=this.options;this.on(i.showBtn,"click",this.show),this.on(i.saveBtn,"click",this.save),this.on(i.hideBtn,"click",this.hide),this.on(i.rotateLeftBtn,"click",function(){return e.rotate(-90)}),this.on(i.rotateRightBtn,"click",function(){return e.rotate(90)}),this.on(i.flipHorizontal,"click",function(){if(e.image){var t=e.image.cropper("getData").scaleX;e.image.cropper("scaleX",1==t?-1:1)}}),this.on(i.flipVertical,"click",function(){if(e.image){var t=e.image.cropper("getData").scaleY;e.image.cropper("scaleY",1==t?-1:1)}}),this.isModal()&&i.container.on("hidden.bs.modal",function(){return e.hide()}).on("shown.bs.modal",function(i){e.loadPreview(i.relatedTarget.fileurl?i.relatedTarget.fileurl:t(i.relatedTarget.currentTarget))}),this.$f.plugins.ui&&(this.on(this.$f.element,"click",i.selectors.crop,this.show),this.$f.on("renderdone",function(e,o){t.each(o.files,function(t,e){e.context.find(i.selectors.crop).data("fileurl",e.url)})}))},i.prototype.show=function(e){if("object"===t.type(e))e.preventDefault();else{var i=e;e=t.Event("click"),e.fileurl=i}this.isModal()?this.options.container.modal("show",e):(this.options.container.show(),this.loadPreview(t(e.currentTarget)))},i.prototype.loadPreview=function(e){e instanceof t?(this.fileContext=t(e).closest(".download-template"),this.loadImage(t(e).data("fileurl"))):this.loadImage(e)},i.prototype.loadImage=function(e){var i=this,n=t("<img>",{src:o(e),"class":"img-responsive"});n.on("load",function(t){return i.trigger("cropload",t,n)}).on("error",function(t){return i.trigger("croploadfail",t,n)})},i.prototype.hide=function(){this.isModal()?this.options.container.modal("hide"):this.options.container.hide(),this.options._preview.html("")},i.prototype.save=function(t){var e=this;this.toggleSaveBtn(),this.image.cropper("disable");var i=this.image.cropper("getData");this.$f.update(this.getFilename(),i).done(function(i,n,r){i.versions&&i.versions.thumb&&(i.versions.thumb.url=o(i.versions.thumb.url)),e.fileContext&&(i.original={context:e.fileContext}),e.trigger("cropsave",t,[i,r])}).fail(function(i){return e.trigger("cropsavefail",t,i)}).always(function(i){return e.trigger("cropsavealways",t,i)})},i.prototype.rotate=function(t){if(!this.image)return!1;var e=this.image,i=e.cropper("getContainerData");e.cropper("setCropBoxData",{width:2,height:2,top:i.height/2-1,left:i.width/2-1}),e.cropper("rotate",t);var o=void 0,n=e.cropper("getCanvasData"),r=n.width*(i.height/n.height);if(r>=i.width){var a=n.height*(i.width/n.width);o={width:i.width,height:a,top:(i.height-a)/2,left:0}}else o={width:r,height:i.height,top:0,left:(i.width-r)/2};e.cropper("setCanvasData",o),o.top=o.top+.1*o.height,o.left=o.left+.1*o.width,o.height=.8*o.height,o.width=.8*o.width,e.cropper("setCropBoxData",o)},i.prototype.getFilename=function(){var t=this.image.attr("src");return t.indexOf("?file=")>-1&&(t=t.substr(t.indexOf("?file=")+6)),(t.indexOf("?")>-1||t.indexOf("&")>-1)&&(t=t.substr(0,t.length-14)),decodeURI(t)},i.prototype.toggleSaveBtn=function(){var e=this.options.saveBtn;t.fn.button?e.button().data("bs.button").isLoading?e.button("reset"):e.button("loading"):e.prop("disabled",!e.prop("disabled"))},i.prototype.isModal=function(){return this.options.container&&this.options.container.hasClass("modal")},e.plugin("crop",i)});