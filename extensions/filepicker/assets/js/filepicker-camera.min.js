!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?e(require("jquery"),require("filepicker")):"function"==typeof define&&define.amd?define(["jquery","filepicker"],e):e(t.jQuery,t.Filepicker)}(this,function(t,e){"use strict";function i(t){t.extend(this,o)}t="default"in t?t["default"]:t,e="default"in e?e["default"]:e;var o={camera:{constraints:{},flipHorizontal:!0,selectors:{container:"#camera-modal",show:".camera-show",hide:".camera-hide",capture:".camera-capture",preview:".camera-preview"}},messages:{cameraError:"Could not access the camera.",cameraFallback:"Your browser does not support the camera feature."},cameracapture:function(t,e){this.onAdd(t,e),this.plugins.camera.hide()},camerasuccess:function(t,e){var i=this.plugins.camera;i.stream=e,i.video.attr("src",window.URL.createObjectURL(e)||e),i.video.on("loadedmetadata",function(){i.options.captureBtn.prop("disabled",!1)}),i.options.flipHorizontal&&i.flipHorizontal()},cameraerror:function(t,e){alert(this.trans("cameraError",{error:e})),this.plugins.camera.hide()},camerafallback:function(t,e){alert(e)}};i.prototype.init=function(){this.options=this.$f.options.camera,this._initOptions(),this._initHandlers()},i.prototype._initOptions=function(){var e=this.options,i=this.options.selectors;return this.mediaDevices=this._getMediaDevices(),e.container||(e.container=t(i.container)),e.container?(e.showBtn||(e.showBtn=this.$f.element.find(i.show)),e.hideBtn||(e.hideBtn=e.container.find(i.hide)),e.captureBtn||(e.captureBtn=e.container.find(i.capture)),e.preview||(e.preview=e.container.find(i.preview)),void e.captureBtn.prop("disabled",!0)):!1},i.prototype._initHandlers=function(){var t=this,e=this.options;this.on(e.showBtn,"click",this.show),this.on(e.hideBtn,"click",this.hide),this.on(e.captureBtn,"click",this.capture),this.isModal()&&e.container.on("shown.bs.modal",function(){return t.startStream()}).on("hidden.bs.modal",function(){return t.hide()})},i.prototype.show=function(t){return this.mediaDevices?void(this.isModal()?this.options.container.modal("show"):(this.options.container.show(),this.startStream())):this.trigger("camerafallback",t,this.$f.trans("cameraFallback"))},i.prototype.hide=function(){this.isModal()?this.options.container.modal("hide"):this.options.container.hide(),this.stopStream()},i.prototype.capture=function(t){var e={files:[this.getBlob()],autoUpload:!0};this.trigger("cameracapture",t,e)},i.prototype.startStream=function(){var e=this;this.video=t("<video autoplay></video>"),this.options.preview.html(this.video).show(),this.mediaDevices.getUserMedia({audio:!1,video:this.options.constraints}).then(function(t){return e.trigger("camerasuccess",null,t)})["catch"](function(t){return e.trigger("cameraerror",null,t)})},i.prototype.stopStream=function(){if(this.stream){if(this.stream.getVideoTracks){var t=this.stream.getVideoTracks();t&&t[0]&&t[0].stop&&t[0].stop()}else this.stream.stop&&this.stream.stop();delete this.stream}this.video&&(this.video.remove(),delete this.video)},i.prototype.flipHorizontal=function(){this.options.preview.css({transform:"scaleX(-1)",mozTransform:"scaleX(-1)",webkitTransform:"scaleX(-1)"})},i.prototype.getBlob=function(){var t=this._getDataUri(),e=t.split("data:image/jpeg;base64,")[1],i=this._encode(e),o=new Blob([i],{type:"image/jpeg"});return o.name="camera"+Math.round(1e3*Math.random())+".jpg",o.lastModifiedDate=new Date,o},i.prototype._getDataUri=function(){var t=document.createElement("canvas");t.width=this.video[0].videoWidth,t.height=this.video[0].videoHeight;var e=t.getContext("2d");return this.options.flipHorizontal&&(e.translate(this.video[0].videoWidth,0),e.scale(-1,1)),e.drawImage(this.video[0],0,0),t.toDataURL("image/jpeg")},i.prototype.isModal=function(){return this.options.container&&this.options.container.hasClass("modal")},i.prototype._getMediaDevices=function(){return navigator.mediaDevices&&navigator.mediaDevices.getUserMedia?navigator.mediaDevices:navigator.mozGetUserMedia||navigator.webkitGetUserMedia?{getUserMedia:function(t){return new Promise(function(e,i){(navigator.mozGetUserMedia||navigator.webkitGetUserMedia).call(navigator,t,e,i)})}}:null},i.prototype._encode=function(t){for(var e=atob(t),i=e.length,o=new ArrayBuffer(i),a=new Uint8Array(o),r=0;i>r;r++)a[r]=e.charCodeAt(r);return o},e.plugin("camera",i)});